<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ </title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>A10ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</h1>
        <div class="user-name" id="userNameDisplay"></div>
    </header>

    <main>
        <section class="chat-header">
            <h2 id="roomTitle">ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ </h2>
            <p id="roomSummary" class="chat-room-summary"></p>
        </section>

        <section class="chat-container">
            <div id="messages" class="chat-messages"></div>
            <form id="chatForm" class="chat-form">
                <input
                    type="text"
                    id="messageInput"
                    class="chat-input"
                    placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ Enter ã§é€ä¿¡"
                    autocomplete="off"
                    required
                />
                <button type="submit" class="chat-send-button">é€ä¿¡</button>
            </form>
        </section>
    </main>

    <footer>
        <a href="button1.html" class="footer-btn"><img src="img/page1.png" alt="ãƒœã‚¿ãƒ³1"></a>
        <a href="button2.html" class="footer-btn"><img src="img/page2.png" alt="ãƒœã‚¿ãƒ³2"></a>
        <a href="team.html" class="footer-btn team-btn">ğŸ‘¥</a>
        <a href="settings.html" class="footer-btn settings-btn">âš™ï¸</a>
    </footer>

    <script>
        function getUserProfile() {
            const storedUsername = localStorage.getItem('username') || '';
            const raw = localStorage.getItem('userProfile');
            let profile = { username: storedUsername, gender: '', birthdate: '', hobbies: [], icon: '' };
            if (raw) {
                try {
                    const parsed = JSON.parse(raw);
                    profile = { ...profile, ...parsed };
                } catch (e) {}
            }
            if (!profile.username && storedUsername) profile.username = storedUsername;
            return profile;
        }

        function applyHeaderProfile() {
            const el = document.getElementById('userNameDisplay');
            if (!el) return;

            const profile = getUserProfile();
            if (!profile.username) {
                el.textContent = '';
                return;
            }

            const iconHtml = profile.icon ? `<span class="user-icon">${profile.icon}</span>` : '';
            el.innerHTML =
                `<span class="user-name-content">` +
                iconHtml +
                `<span class="user-name-text">${profile.username}</span>` +
                `</span>`;
        }

        applyHeaderProfile();

        const username = localStorage.getItem('username');

        const roomsKey = 'talkRooms';

        function loadRooms() {
            const raw = localStorage.getItem(roomsKey);
            if (!raw) return [];
            try {
                return JSON.parse(raw);
            } catch {
                return [];
            }
        }

        const currentRoomId = localStorage.getItem('currentRoomId');
        const rooms = loadRooms();
        const currentRoom = rooms.find((r) => r.id === currentRoomId);

        const roomTitle = document.getElementById('roomTitle');
        const roomSummary = document.getElementById('roomSummary');

        if (currentRoom) {
            roomTitle.textContent = currentRoom.name;
            roomSummary.textContent = currentRoom.summary || 'ã“ã®éƒ¨å±‹ã®æ¦‚è¦ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚';
        } else {
            roomTitle.textContent = 'éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
            roomSummary.textContent = 'ãƒãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‹ã‚‰éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®èª­ã¿æ›¸ã
        function getMessagesKey(roomId) {
            return 'messages_' + roomId;
        }

        function loadMessages(roomId) {
            if (!roomId) return [];
            const raw = localStorage.getItem(getMessagesKey(roomId));
            if (!raw) return [];
            try {
                return JSON.parse(raw);
            } catch {
                return [];
            }
        }

        function saveMessages(roomId, messages) {
            if (!roomId) return;
            localStorage.setItem(getMessagesKey(roomId), JSON.stringify(messages));
        }

        const messagesContainer = document.getElementById('messages');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');

        function renderMessages() {
            const msgs = loadMessages(currentRoomId);
            messagesContainer.innerHTML = '';
            
            // ã‚·ã‚¹ãƒ†ãƒ ç›£æŸ»æŠ€è¡“è€…è©¦é¨“ã®éƒ¨å±‹ã§ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºã®å ´åˆã€åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if (currentRoom && currentRoom.id === 'system_audit_room' && msgs.length === 0) {
                const initialMessage = document.createElement('div');
                initialMessage.className = 'chat-message-speech-bubble';
                initialMessage.innerHTML = `
                    <div class="speech-bubble-container">
                        <img src="img/marisa.png" alt="é­”ç†æ²™" class="speech-bubble-icon">
                        <div class="speech-bubble">
                            <p>ä»Šåº¦ã®è©¦é¨“ã„ã¤ãªã®ãœ</p>
                            <p>ä¸å®‰ãªã®ãœ</p>
                        </div>
                    </div>
                `;
                messagesContainer.appendChild(initialMessage);
            } else {
                msgs.forEach((m) => {
                    const item = document.createElement('div');
                    item.className = 'chat-message';
                    const namePart = m.user ? m.user + 'ï¼š' : '';
                    item.textContent = namePart + m.text;
                    messagesContainer.appendChild(item);
                });
            }
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        if (!currentRoom) {
            chatForm.style.display = 'none';
        } else {
            chatForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const text = messageInput.value.trim();
                if (!text) return;

                const msgs = loadMessages(currentRoomId);
                msgs.push({
                    text,
                    user: username || 'åŒ¿å',
                    ts: Date.now(),
                });
                saveMessages(currentRoomId, msgs);
                messageInput.value = '';
                renderMessages();
            });
        }

        renderMessages();
    </script>
</body>
</html>


