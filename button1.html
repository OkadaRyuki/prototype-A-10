<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒœã‚¿ãƒ³1</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>A10ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</h1>
        <div class="user-name" id="userNameDisplay"></div>
    </header>
    
    <main>
        <h1>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h1>
        <div class="users-container" id="usersContainer">
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
        </div>
    </main>
    
    <footer>
        <a href="button1.html" class="footer-btn">ãƒœã‚¿ãƒ³1</a>
        <a href="team.html" class="footer-btn team-btn">ğŸ‘¥</a>
        <a href="settings.html" class="footer-btn settings-btn">âš™ï¸</a>
    </footer>
    
    <script>
        function getUserProfile() {
            const storedUsername = localStorage.getItem('username') || '';
            const raw = localStorage.getItem('userProfile');
            let profile = { username: storedUsername, gender: '', birthdate: '', hobbies: [], icon: '' };
            if (raw) {
                try {
                    const parsed = JSON.parse(raw);
                    profile = { ...profile, ...parsed };
                } catch (e) {}
            }
            if (!profile.username && storedUsername) profile.username = storedUsername;
            return profile;
        }

        function applyHeaderProfile() {
            const el = document.getElementById('userNameDisplay');
            if (!el) return;

            const profile = getUserProfile();
            if (!profile.username) {
                el.textContent = '';
                return;
            }

            const iconHtml = profile.icon ? `<span class="user-icon">${profile.icon}</span>` : '';
            el.innerHTML =
                `<span class="user-name-content">` +
                iconHtml +
                `<span class="user-name-text">${profile.username}</span>` +
                `</span>`;
        }

        applyHeaderProfile();

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã®è¡¨ç¤º
        function getAllUsers() {
            const raw = localStorage.getItem('allUsers');
            if (!raw) return [];
            try {
                return JSON.parse(raw);
            } catch (e) {
                return [];
            }
        }

        function getHobbyDisplayName(hobby) {
            const hobbyMap = {
                'sports': 'ã‚¹ãƒãƒ¼ãƒ„',
                'games': 'ã‚²ãƒ¼ãƒ ',
                'music': 'éŸ³æ¥½',
                'reading': 'èª­æ›¸',
                'travel': 'æ—…è¡Œ'
            };
            return hobbyMap[hobby] || hobby;
        }

        function renderUsers() {
            const usersContainer = document.getElementById('usersContainer');
            const users = getAllUsers();
            const currentUser = getUserProfile();
            
            if (users.length === 0) {
                usersContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">ç™»éŒ²ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“ã€‚</p>';
                return;
            }

            usersContainer.innerHTML = users.map(user => {
                const icon = user.icon || '';
                const username = user.username || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åä¸æ˜';
                const department = user.department || 'æœªè¨­å®š';
                const selfIntroduction = user.selfIntroduction !== undefined && user.selfIntroduction !== null ? user.selfIntroduction : '';
                const hobbies = Array.isArray(user.hobbies) && user.hobbies.length > 0
                    ? user.hobbies.map(h => getHobbyDisplayName(h)).join('ã€')
                    : 'æœªè¨­å®š';
                const club = user.club || 'æœªè¨­å®š';

                // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€ãƒˆã‚°ãƒ«ãŒã‚ªãƒ•ã®é …ç›®ã‚’éè¡¨ç¤º
                const isCurrentUser = currentUser.username && user.username === currentUser.username;
                const showDepartment = isCurrentUser ? (user.showDepartment !== false) : true;
                const showClub = isCurrentUser ? (user.showClub !== false) : true;

                // ã‚¢ã‚¤ã‚³ãƒ³ã®è¡¨ç¤ºï¼ˆç”»åƒãƒ‘ã‚¹ã®å ´åˆã¯<img>ã‚¿ã‚°ã€ãã‚Œä»¥å¤–ã¯ãƒ†ã‚­ã‚¹ãƒˆï¼‰
                let iconHtml = '';
                if (icon) {
                    if (icon.startsWith('img/') || icon.includes('.png') || icon.includes('.jpg') || icon.includes('.jpeg')) {
                        iconHtml = `<span class="user-card-icon"><img src="${icon}" alt="ã‚¢ã‚¤ã‚³ãƒ³" class="user-card-icon-img"></span>`;
                    } else {
                        iconHtml = `<span class="user-card-icon">${icon}</span>`;
                    }
                }

                return `
                    <div class="user-card">
                        <div class="user-card-header">
                            ${iconHtml}
                            <h3 class="user-card-name">${username}</h3>
                        </div>
                        <div class="user-card-body">
                            ${showDepartment ? `
                            <div class="user-card-field">
                                <span class="user-card-label">å­¦éƒ¨ï¼š</span>
                                <span class="user-card-value">${department}</span>
                            </div>
                            ` : ''}
                            <div class="user-card-field">
                                <span class="user-card-label">è‡ªå·±ç´¹ä»‹ï¼š</span>
                                <p class="user-card-introduction">${selfIntroduction || ''}</p>
                            </div>
                            <div class="user-card-field">
                                <span class="user-card-label">è¶£å‘³ï¼š</span>
                                <span class="user-card-value">${hobbies}</span>
                            </div>
                            ${showClub ? `
                            <div class="user-card-field">
                                <span class="user-card-label">æ‰€å±ã‚µãƒ¼ã‚¯ãƒ«ï¼š</span>
                                <span class="user-card-value">${club}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        renderUsers();

        // åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ç™»éŒ²ï¼ˆæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
        function initializeUsers() {
            const allUsers = getAllUsers();
            const existingUsernames = allUsers.map(u => u.username);
            
            const initialUsers = [
                {
                    username: 'ã—ã‚ƒã‚ã„ã¾ã‚‹',
                    icon: 'img/syameimaru.png',
                    gender: 'male',
                    department: 'æƒ…å ±å·¥å­¦éƒ¨',
                    selfIntroduction: '',
                    hobbies: [],
                    club: 'è»½éŸ³éƒ¨'
                },
                {
                    username: 'é­”ç†æ²™',
                    icon: 'img/marisa.png',
                    gender: 'female',
                    department: 'æƒ…å ±å·¥å­¦éƒ¨',
                    selfIntroduction: '',
                    hobbies: [],
                    club: 'ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«éƒ¨'
                },
                {
                    username: 'éœŠå¤¢',
                    icon: 'img/reimu.png',
                    gender: 'female',
                    department: 'æƒ…å ±å·¥å­¦éƒ¨',
                    selfIntroduction: '',
                    hobbies: [],
                    club: 'ãªã—'
                },
                {
                    username: 'ãƒãƒ«ãƒ',
                    icon: 'img/tiruno.png',
                    gender: 'female',
                    department: 'æƒ…å ±å·¥å­¦éƒ¨',
                    selfIntroduction: '',
                    hobbies: [],
                    club: 'å†™çœŸéƒ¨'
                },
                {
                    username: 'é«˜æ©‹',
                    icon: 'img/takahashi.png',
                    gender: 'male',
                    department: 'æƒ…å ±å·¥å­¦éƒ¨',
                    selfIntroduction: '',
                    hobbies: [],
                    club: 'æƒ…å ±æŠ€è¡“ç ”ç©¶ä¼š'
                }
            ];

            let updated = false;
            initialUsers.forEach(user => {
                const existingIndex = allUsers.findIndex(u => u.username === user.username);
                if (existingIndex >= 0) {
                    // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰€å±ã‚µãƒ¼ã‚¯ãƒ«ã‚’æ›´æ–°
                    if (!allUsers[existingIndex].club) {
                        allUsers[existingIndex].club = user.club;
                        updated = true;
                    }
                } else {
                    // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
                    allUsers.push(user);
                    updated = true;
                }
            });

            if (updated) {
                localStorage.setItem('allUsers', JSON.stringify(allUsers));
                renderUsers();
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²
        initializeUsers();
    </script>
</body>
</html>

