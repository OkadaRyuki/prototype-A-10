<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ¼ãƒ </title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>A10ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</h1>
        <div class="user-name" id="userNameDisplay"></div>
    </header>

    <main>
        <h1>ãƒãƒ¼ãƒ ãƒšãƒ¼ã‚¸</h1>
        <p>ç›¸è«‡éƒ¨å±‹ã‚’ä½œæˆã—ã¦ã€ãƒãƒ¼ãƒ ã§ãƒˆãƒ¼ã‚¯ã§ãã¾ã™ã€‚</p>

        <div id="roomsContainer" class="rooms-container"></div>

        <!-- ç›¸è«‡éƒ¨å±‹è¿½åŠ ç”¨ã®å††å½¢ãƒœã‚¿ãƒ³ -->
        <button id="addRoomButton" class="floating-add-button">+</button>

        <!-- éƒ¨å±‹è¿½åŠ ç”¨ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ -->
        <div id="roomFormOverlay" class="room-form-overlay hidden">
            <div class="room-form">
                <h2>è¿½åŠ ã—ãŸã„éƒ¨å±‹ã®åå‰ã¯ï¼Ÿ</h2>
                <p class="room-form-description">ç›¸è«‡éƒ¨å±‹ã®åå‰ã¨å¤§ã¾ã‹ãªæ¦‚è¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>

                <label for="roomName">éƒ¨å±‹ã®åå‰</label>
                <input type="text" id="roomName" placeholder="ä¾‹ï¼‰é€²è·¯ç›¸è«‡ãƒ«ãƒ¼ãƒ ">

                <label for="roomSummary">æ¦‚è¦</label>
                <textarea id="roomSummary" rows="3" placeholder="ä¾‹ï¼‰å°±è·æ´»å‹•ã‚„é€²å­¦ã«ã¤ã„ã¦ç›¸è«‡ã™ã‚‹éƒ¨å±‹"></textarea>

                <div class="room-form-buttons">
                    <button id="cancelRoomButton" class="room-cancel-button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button id="saveRoomButton" class="room-save-button">è¿½åŠ </button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <a href="button1.html" class="footer-btn">ãƒœã‚¿ãƒ³1</a>
        <a href="team.html" class="footer-btn team-btn">ğŸ‘¥</a>
        <a href="settings.html" class="footer-btn settings-btn">âš™ï¸</a>
    </footer>

    <script>
        function getUserProfile() {
            const storedUsername = localStorage.getItem('username') || '';
            const raw = localStorage.getItem('userProfile');
            let profile = { username: storedUsername, gender: '', birthdate: '', hobbies: [], icon: '' };
            if (raw) {
                try {
                    const parsed = JSON.parse(raw);
                    profile = { ...profile, ...parsed };
                } catch (e) {}
            }
            if (!profile.username && storedUsername) profile.username = storedUsername;
            return profile;
        }

        function applyHeaderProfile() {
            const el = document.getElementById('userNameDisplay');
            if (!el) return;

            const profile = getUserProfile();
            if (!profile.username) {
                el.textContent = '';
                return;
            }

            const iconHtml = profile.icon ? `<span class="user-icon">${profile.icon}</span>` : '';
            el.innerHTML =
                `<span class="user-name-content">` +
                iconHtml +
                `<span class="user-name-text">${profile.username}</span>` +
                `</span>`;
        }

        applyHeaderProfile();

        // éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ãƒ»ä¿å­˜
        const roomsKey = 'talkRooms';

        function loadRooms() {
            const raw = localStorage.getItem(roomsKey);
            if (!raw) return [];
            try {
                return JSON.parse(raw);
            } catch {
                return [];
            }
        }

        function saveRooms(rooms) {
            localStorage.setItem(roomsKey, JSON.stringify(rooms));
        }

        function renderRooms() {
            const container = document.getElementById('roomsContainer');
            const rooms = loadRooms();
            container.innerHTML = '';

            rooms.forEach((room) => {
                const card = document.createElement('div');
                card.className = 'room-card';
                card.innerHTML = `
                    <h3 class="room-title">${room.name}</h3>
                    <p class="room-summary">${room.summary}</p>
                `;
                card.addEventListener('click', () => {
                    localStorage.setItem('currentRoomId', room.id);
                    window.location.href = 'talk.html';
                });
                container.appendChild(card);
            });
        }

        // å††å½¢ãƒœã‚¿ãƒ³ã¨ãƒ•ã‚©ãƒ¼ãƒ ã®åˆ¶å¾¡
        const addRoomButton = document.getElementById('addRoomButton');
        const roomFormOverlay = document.getElementById('roomFormOverlay');
        const cancelRoomButton = document.getElementById('cancelRoomButton');
        const saveRoomButton = document.getElementById('saveRoomButton');
        const roomNameInput = document.getElementById('roomName');
        const roomSummaryInput = document.getElementById('roomSummary');

        function openRoomForm() {
            roomNameInput.value = '';
            roomSummaryInput.value = '';
            roomFormOverlay.classList.remove('hidden');
        }

        function closeRoomForm() {
            roomFormOverlay.classList.add('hidden');
        }

        addRoomButton.addEventListener('click', openRoomForm);
        cancelRoomButton.addEventListener('click', closeRoomForm);
        roomFormOverlay.addEventListener('click', (e) => {
            if (e.target === roomFormOverlay) {
                closeRoomForm();
            }
        });

        saveRoomButton.addEventListener('click', () => {
            const name = roomNameInput.value.trim();
            const summary = roomSummaryInput.value.trim();

            if (!name) {
                alert('éƒ¨å±‹ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const rooms = loadRooms();
            const id = `room_${Date.now()}`;
            rooms.unshift({ id, name, summary }); // ä¸Šã‹ã‚‰é †ã«è¿½åŠ 
            saveRooms(rooms);

            closeRoomForm();
            renderRooms();
        });

        // ã‚·ã‚¹ãƒ†ãƒ ç›£æŸ»æŠ€è¡“è€…è©¦é¨“ã®éƒ¨å±‹ã‚’å¸¸æ™‚è¡¨ç¤º
        function ensureSystemAuditRoom() {
            const rooms = loadRooms();
            const systemAuditRoomId = 'system_audit_room';
            const existingRoom = rooms.find(r => r.id === systemAuditRoomId);
            
            if (!existingRoom) {
                rooms.unshift({
                    id: systemAuditRoomId,
                    name: 'ã‚·ã‚¹ãƒ†ãƒ ç›£æŸ»æŠ€è¡“è€…è©¦é¨“',
                    summary: 'ã‚·ã‚¹ãƒ†ãƒ ç›£æŸ»æŠ€è¡“è€…è©¦é¨“ã«ã¤ã„ã¦è©±ã—åˆã†éƒ¨å±‹'
                });
                saveRooms(rooms);
            }
        }

        // åˆæœŸè¡¨ç¤º
        ensureSystemAuditRoom();
        renderRooms();
    </script>
</body>
</html>

